<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Google Drive Uploader & Preview</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', 
                        secondary: '#10b981', 
                        danger: '#ef4444', 
                        // Dynamic Colors mapped to CSS Variables
                        main: 'var(--bg-main)',
                        deep: 'var(--bg-deep)',
                        surface: 'var(--bg-surface)',
                        text: 'var(--text-main)',
                        muted: 'var(--text-muted)',
                        border: 'var(--border-color)',
                        hover: 'var(--bg-hover)',
                    }
                }
            }
        }
    </script>
    
    <!-- Google API Scripts -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        /* Color System Variables */
        :root {
            /* Light Mode (Default) */
            --bg-main: #f8fafc;       /* Slate 50 */
            --bg-deep: #ffffff;       /* White */
            --bg-surface: #ffffff;    /* White */
            --text-main: #0f172a;     /* Slate 900 */
            --text-muted: #64748b;    /* Slate 500 */
            --border-color: #e2e8f0;  /* Slate 200 */
            --bg-hover: #f1f5f9;      /* Slate 100 */
        }

        [data-theme='dark'] {
            /* Dark Mode */
            --bg-main: #0f172a;       /* Slate 900 */
            --bg-deep: #020617;       /* Slate 950 */
            --bg-surface: #1e293b;    /* Slate 800 */
            --text-main: #f1f5f9;     /* Slate 100 */
            --text-muted: #94a3b8;    /* Slate 400 */
            --border-color: #334155;  /* Slate 700 */
            --bg-hover: #334155;      /* Slate 700 */
        }

        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: var(--bg-main); 
            color: var(--text-main); 
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s, color 0.3s;
        }

        .glass-panel { background: var(--bg-surface); backdrop-filter: blur(10px); }
        
        .loader { border: 3px solid var(--border-color); border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        .loader-lg { width: 48px; height: 48px; border-width: 4px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        
        /* Background Pattern */
        .bg-pattern {
            background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }
        .animate-bounce-slow {
            animation: bounce-slow 3s infinite ease-in-out;
        }
        .animate-fade-in {
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

    // --- CONFIGURATION (OBFUSCATED) ---
    const _d = (arr) => arr.map(c => String.fromCharCode(c)).join('');

    // Encoded Credentials (ASCII)
    const API_KEY = _d([65,73,122,97,83,121,67,83,104,84,72,108,86,50,111,70,114,55,81,77,78,101,116,71,56,49,86,95,120,57,57,122,101,68,88,66,85,116,85]);
    const CLIENT_ID = _d([56,51,57,48,49,52,50,51,54,56,54,48,45,112,102,98,54,48,110,107,108,55,107,108,112,101,106,50,98,102,54,55,116,115,104,53,113,104,106,110,116,116,101,105,57,46,97,112,112,115,46,103,111,111,103,108,101,117,115,101,114,99,111,110,116,101,110,116,46,99,111,109]);
    const SCOPES = _d([104,116,116,112,115,58,47,47,119,119,119,46,103,111,111,103,108,101,97,112,105,115,46,99,111,109,47,97,117,116,104,47,100,114,105,118,101,46,102,105,108,101]);
    const FOLDER_NAME = _d([85,112,108,111,97,100,70,105,108,101]);
    const DISCOVERY_DOC = _d([104,116,116,112,115,58,47,47,119,119,119,46,103,111,111,103,108,101,97,112,105,115,46,99,111,109,47,100,105,115,99,111,118,101,114,121,47,118,49,47,97,112,105,115,47,100,114,105,118,101,47,118,51,47,114,101,115,116]);
    const REDIRECT_URL = 'https://chaiwat20180.github.io/PreviewFile/';

    // --- COMPONENTS ---
    
    const FileIcon = ({ mimeType }) => {
        let iconClass = "fa-file text-muted";
        if (mimeType.includes('image')) iconClass = "fa-file-image text-purple-500";
        else if (mimeType.includes('pdf')) iconClass = "fa-file-pdf text-red-500";
        else if (mimeType.includes('html')) iconClass = "fa-brands fa-html5 text-orange-500";
        else if (mimeType.includes('video')) iconClass = "fa-file-video text-blue-500";
        else if (mimeType.includes('folder')) iconClass = "fa-folder text-yellow-500";
        
        return <i className={`fas ${iconClass} text-xl`}></i>;
    };

    const App = () => {
        const [user, setUser] = React.useState(null); // true if logged in
        const [isGuest, setIsGuest] = React.useState(false); // New: Guest mode state
        const [isSharedView, setIsSharedView] = React.useState(false); // New: Shared view mode
        const [userId, setUserId] = React.useState(null); // Unique User ID from Google
        const [tokenClient, setTokenClient] = React.useState(null);
        const [gapiInited, setGapiInited] = React.useState(false);
        const [gisInited, setGisInited] = React.useState(false);
        const [files, setFiles] = React.useState([]);
        const [uploading, setUploading] = React.useState(false);
        const [previewFile, setPreviewFile] = React.useState(null); 
        const [isFullScreen, setIsFullScreen] = React.useState(false);
        const [previewLoading, setPreviewLoading] = React.useState(false);
        const [isDarkMode, setIsDarkMode] = React.useState(true);
        const [deletingId, setDeletingId] = React.useState(null);
        const [isClearing, setIsClearing] = React.useState(false);
        const [sharingId, setSharingId] = React.useState(null);
        
        // Image Manipulation State
        const [imgScale, setImgScale] = React.useState(1);
        const [imgRotate, setImgRotate] = React.useState(0);
        const [pan, setPan] = React.useState({ x: 0, y: 0 });
        const [isDragging, setIsDragging] = React.useState(false);
        const [dragStart, setDragStart] = React.useState({ x: 0, y: 0 });

        // --- THEME LOGIC ---
        React.useEffect(() => {
            const root = document.documentElement;
            if (isDarkMode) {
                root.setAttribute('data-theme', 'dark');
            } else {
                root.setAttribute('data-theme', 'light');
            }
        }, [isDarkMode]);

        const toggleTheme = () => {
            setIsDarkMode(!isDarkMode);
        };

        // --- DRIVE HELPER FUNCTIONS ---
        const getOrCreateFolder = async () => {
            try {
                const q = `mimeType='application/vnd.google-apps.folder' and name='${FOLDER_NAME}' and trashed=false`;
                const response = await gapi.client.drive.files.list({
                    q: q,
                    fields: 'files(id, name)',
                    spaces: 'drive',
                });

                if (response.result.files.length > 0) {
                    return response.result.files[0].id;
                } else {
                    const fileMetadata = {
                        name: FOLDER_NAME,
                        mimeType: 'application/vnd.google-apps.folder',
                    };
                    const folder = await gapi.client.drive.files.create({
                        resource: fileMetadata,
                        fields: 'id',
                    });
                    return folder.result.id;
                }
            } catch (err) {
                console.error("Error getting folder:", err);
                return null;
            }
        };

        const syncFilesFromDrive = async (uid) => {
            try {
                const folderId = await getOrCreateFolder();
                if (!folderId) return;

                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and trashed=false`,
                    fields: 'files(id, name, mimeType, webViewLink)',
                    orderBy: 'createdTime desc',
                    pageSize: 100 
                });

                const driveFiles = response.result.files.map(file => ({
                    id: file.id,
                    name: file.name,
                    mimeType: file.mimeType,
                    webViewLink: file.webViewLink,
                    source: 'drive'
                }));

                setFiles(driveFiles);
            } catch (err) {
                console.error("Sync error:", err);
            }
        };

        // --- AUTH & INIT LOGIC ---
        React.useEffect(() => {
            const initializeGapiClient = async () => {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                setGapiInited(true);
                
                const urlParams = new URLSearchParams(window.location.search);
                const sharedId = urlParams.get('id');
                
                // Check for existing session
                const storedToken = localStorage.getItem('gdrive_access_token');
                const storedGuest = localStorage.getItem('gdrive_guest_mode');

                if (storedToken) {
                    try {
                        gapi.client.setToken({ access_token: storedToken });
                        setUser(true);
                        setIsGuest(false);
                        fetchUserProfile();
                        
                        if (sharedId) {
                            loadSharedFile(sharedId, true); 
                        }
                    } catch (e) {
                        console.error("Error restoring token", e);
                        localStorage.removeItem('gdrive_access_token');
                    }
                } else if (storedGuest === 'true') {
                    setIsGuest(true);
                    setUser(null);
                    setUserId('guest');
                    
                    if (sharedId) {
                        loadSharedFile(sharedId, true);
                    }
                } else {
                    if (sharedId) {
                        loadSharedFile(sharedId, false);
                    }
                }
            };

            gapi.load('client', initializeGapiClient);

            const client = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: async (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        localStorage.setItem('gdrive_access_token', tokenResponse.access_token);
                        window.location.href = REDIRECT_URL;
                    }
                },
            });
            setTokenClient(client);
            setGisInited(true);
        }, []);

        // --- FETCH SHARED FILE ---
        const loadSharedFile = async (id, isAuthenticated) => {
            setPreviewLoading(true);
            if (!isAuthenticated) {
                setIsSharedView(true);
            }
            
            try {
                if (!gapi.client) await new Promise(r => setTimeout(r, 500));

                const response = await gapi.client.drive.files.get({
                    fileId: id,
                    fields: 'id, name, mimeType, webViewLink'
                });
                const file = response.result;
                
                if (!isAuthenticated) {
                    setFiles([file]);
                } 

                loadFileContentForPreview(file.id, file.mimeType, file.name);
                
                const Toast = Swal.mixin({
                    toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true
                });
                Toast.fire({ icon: 'success', title: 'กำลังดูไฟล์ที่แชร์' });

            } catch (err) {
                console.error("Load shared file error:", err);
                Swal.fire({
                    icon: 'error',
                    title: 'ไม่สามารถเปิดไฟล์ได้',
                    text: 'ไฟล์อาจถูกลบ หรือคุณไม่มีสิทธิ์เข้าถึง',
                    confirmButtonText: 'ตกลง'
                });
                setPreviewLoading(false);
            }
        };

        // --- USER PROFILE ---
        const fetchUserProfile = async () => {
            try {
                const response = await gapi.client.drive.about.get({
                    fields: 'user'
                });
                const currentUser = response.result.user;
                const uniqueId = currentUser.permissionId;
                setUserId(uniqueId);
                
                syncFilesFromDrive(uniqueId);
            } catch (err) {
                console.error("Error fetching user profile:", err);
                if (err.status === 401) handleSignoutClick();
            }
        };

        // --- ACTIONS ---
        const handleAuthClick = () => {
            if (tokenClient) {
                tokenClient.requestAccessToken();
            }
        };

        const handleGuestClick = () => {
            localStorage.setItem('gdrive_guest_mode', 'true');
            window.location.href = REDIRECT_URL;
        };

        const handleSignoutClick = () => {
            if (isGuest) {
                localStorage.removeItem('gdrive_guest_mode');
            }
            
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            localStorage.removeItem('gdrive_access_token'); 
            
            window.location.href = REDIRECT_URL;
        };

        const handleClearHistory = async () => {
            if (files.length === 0) return;

            if (isGuest) {
                Swal.fire({
                    title: 'ยืนยันการล้างรายการ?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ล้าง',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed) {
                        setFiles([]);
                        setPreviewFile(null);
                    }
                });
                return;
            }

            Swal.fire({
                title: 'คำเตือน!',
                text: 'การล้างประวัติจะทำการ "ลบไฟล์จริง" ออกจาก Google Drive ด้วย คุณแน่ใจหรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ลบทั้งหมด',
                cancelButtonText: 'ยกเลิก'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    setIsClearing(true);
                    try {
                        const deletePromises = files.map(file => 
                            gapi.client.drive.files.delete({ fileId: file.id })
                                .then(() => true)
                                .catch(err => {
                                    console.error(`Failed to delete ${file.id}`, err);
                                    return false; 
                                })
                        );

                        await Promise.all(deletePromises);

                        if (userId) syncFilesFromDrive(userId);
                        else setFiles([]);

                        setPreviewFile(null);
                        Swal.fire('ลบเสร็จสิ้น!', 'ไฟล์ทั้งหมดถูกลบเรียบร้อยแล้ว', 'success');

                    } catch (err) {
                        console.error("Clear history error:", err);
                        Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถลบไฟล์บางรายการได้', 'error');
                    } finally {
                        setIsClearing(false);
                    }
                }
            });
        };

        const handleShareFile = async (e, file) => {
            e.stopPropagation();
            
            // Handle GUEST MODE Sharing (Public Cloud Upload)
            if (file.source === 'local') {
                Swal.fire({
                    title: 'อัปโหลดเพื่อแชร์?',
                    text: "เนื่องจากคุณไม่ได้ Login ไฟล์จะถูกอัปโหลดไปยัง Cloud สาธารณะ (Litterbox) แบบชั่วคราว (24 ชั่วโมง) เพื่อสร้างลิงก์",
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'อัปโหลดและแชร์',
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#10b981'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        setSharingId(file.id);
                        Swal.fire({
                            title: 'กำลังอัปโหลด...',
                            html: 'กำลังส่งข้อมูลไปยัง Server (Litterbox)...<br><span class="text-xs text-red-400">*หากล้มเหลว อาจเกิดจากข้อจำกัดเครือข่าย/CORS</span>',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        try {
                            // Convert blob url back to blob/file
                            const blob = await fetch(file.blobUrl).then(r => r.blob());
                            const formData = new FormData();
                            formData.append('reqtype', 'fileupload');
                            formData.append('time', '24h');
                            formData.append('fileToUpload', blob, file.name);
                            
                            // Upload to Litterbox (Catbox)
                            const response = await fetch('https://litterbox.catbox.moe/resources/internals/api.php', {
                                method: 'POST',
                                body: formData
                            });

                            if (!response.ok) {
                                throw new Error(`Server Error: ${response.status}`);
                            }

                            // Litterbox returns the URL as plain text
                            const shareLink = await response.text();
                            
                            if (shareLink.startsWith('http')) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'สร้างลิงก์แชร์สำเร็จ!',
                                    html: `<p class="text-sm mb-2">ลิงก์นี้จะใช้ได้ 24 ชั่วโมง:</p>
                                           <input type="text" value="${shareLink}" class="w-full p-2 border rounded bg-gray-50 text-sm text-center" readonly onclick="this.select()">`,
                                    confirmButtonText: 'คัดลอกและปิด',
                                    preConfirm: () => {
                                        navigator.clipboard.writeText(shareLink);
                                    }
                                });
                            } else {
                                throw new Error('Upload failed: ' + shareLink);
                            }
                        } catch (err) {
                            console.error("Guest upload error:", err);
                            Swal.fire({
                                icon: 'error',
                                title: 'อัปโหลดไม่สำเร็จ (CORS)',
                                html: `<p class="text-sm text-gray-600 mb-2">${err.message}</p>
                                       <p class="text-xs text-red-500">คำแนะนำ: ระบบ Guest มีข้อจำกัดเรื่องความปลอดภัยของ Browser (CORS) กับเว็บฝากไฟล์ฟรี <br><b>กรุณา Login ด้วย Google เพื่อแชร์ไฟล์ได้อย่างเสถียรและถาวร</b></p>`,
                                confirmButtonText: 'ตกลง'
                            });
                        } finally {
                            setSharingId(null);
                        }
                    }
                });
                return;
            }

            // Handle DRIVE MODE Sharing (Google Drive)
            setSharingId(file.id);
            Swal.fire({
                title: 'กำลังสร้างลิงก์แชร์...',
                html: 'กำลังเปิดสิทธิ์การเข้าถึงและคัดลอกลิงก์',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const token = gapi.client.getToken().access_token;
                
                await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}/permissions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        role: 'reader',
                        type: 'anyone'
                    })
                });

                const customLink = `${REDIRECT_URL}?id=${file.id}`;

                try {
                    await navigator.clipboard.writeText(customLink);
                    Swal.fire({
                        icon: 'success',
                        title: 'คัดลอกลิงก์แล้ว!',
                        html: `<p class="text-sm text-gray-500 mb-2">ส่งลิงก์นี้ให้เพื่อนได้เลย:</p>
                               <input type="text" value="${customLink}" class="w-full p-2 border rounded bg-gray-50 text-sm" readonly>`,
                        confirmButtonText: 'ตกลง'
                    });
                } catch (clipErr) {
                    Swal.fire({
                        icon: 'success',
                        title: 'สร้างลิงก์สำเร็จ',
                        html: `<p class="text-sm mb-2">กรุณาคัดลอกลิงก์ด้านล่าง:</p>
                               <input type="text" value="${customLink}" class="w-full p-2 border rounded bg-gray-50 text-sm" readonly>`,
                        confirmButtonText: 'ตกลง'
                    });
                }

            } catch (err) {
                console.error("Share error:", err);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถแชร์ไฟล์ได้: ' + (err.result?.error?.message || err.message), 'error');
            } finally {
                setSharingId(null);
            }
        };

        const handleDeleteFile = async (e, fileId) => {
            e.stopPropagation(); 
            
            if (isGuest) {
                const updatedFiles = files.filter(f => f.id !== fileId);
                setFiles(updatedFiles);
                if (previewFile && files.find(f => f.id === fileId && previewFile.name === f.name)) {
                    setPreviewFile(null);
                }
                return;
            }

            Swal.fire({
                title: 'ยืนยันการลบไฟล์?',
                text: "ไฟล์จะถูกลบจาก Google Drive อย่างถาวร",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ใช่, ลบเลย',
                cancelButtonText: 'ยกเลิก'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    setDeletingId(fileId);
                    try {
                        await gapi.client.drive.files.delete({
                            fileId: fileId
                        });

                        const updatedFiles = files.filter(f => f.id !== fileId);
                        setFiles(updatedFiles);
                        
                        // Re-sync to keep consistent
                        // if (userId) syncFilesFromDrive(userId);

                        if (previewFile && (previewFile.url.includes(fileId) || (files.find(f => f.id === fileId && previewFile.name === f.name)))) { 
                            setPreviewFile(null);
                        }
                        
                        const Toast = Swal.mixin({
                            toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true
                        });
                        Toast.fire({ icon: 'success', title: 'ลบไฟล์เรียบร้อย' });

                    } catch (err) {
                        console.error("Delete error:", err);
                        Swal.fire('ผิดพลาด', 'ไม่สามารถลบไฟล์ได้', 'error');
                    } finally {
                        setDeletingId(null);
                    }
                }
            });
        };

        const isValidFileType = (file) => {
            const validTypes = ['text/html', 'application/pdf', 'image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (file.name.endsWith('.html') || file.name.endsWith('.htm')) return true;
            return validTypes.some(type => file.type.includes(type) || file.type.startsWith('image/'));
        };

        const uploadSingleFile = async (file) => {
            if (!isValidFileType(file)) return null;

            if (isGuest) {
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const localUrl = URL.createObjectURL(file);
                const newFileObj = {
                    id: 'local_' + Date.now() + Math.random().toString(36).substr(2, 9),
                    name: file.name,
                    mimeType: file.type,
                    webViewLink: null,
                    source: 'local',
                    blobUrl: localUrl
                };
                return newFileObj;
            } else {
                const folderId = await getOrCreateFolder();
                if (!folderId) throw new Error("No folder ID");

                const metadata = {
                    name: file.name,
                    mimeType: file.type || 'application/octet-stream',
                    parents: [folderId],
                };

                const accessToken = gapi.client.getToken().access_token;
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,mimeType,webViewLink', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form,
                });

                if (!response.ok) throw new Error("Upload failed");

                const data = await response.json();
                
                return {
                    id: data.id,
                    name: data.name,
                    mimeType: data.mimeType,
                    webViewLink: data.webViewLink,
                    source: 'drive'
                };
            }
        };

        const handleFilesUpload = async (fileList) => {
            if (!user && !isGuest) {
                Swal.fire('กรุณาล็อกอิน', 'คุณต้องเข้าสู่ระบบก่อนอัปโหลดไฟล์', 'warning');
                return;
            }

            setUploading(true);
            const filesArray = Array.from(fileList);
            let successCount = 0;

            try {
                const uploadPromises = filesArray.map(file => uploadSingleFile(file));
                const results = await Promise.all(uploadPromises);
                
                const newFiles = results.filter(res => res !== null);
                
                if (newFiles.length > 0) {
                    setFiles(prev => {
                        const updated = [...newFiles, ...prev];
                        return updated;
                    });
                    const firstFile = newFiles[0];
                    loadFileContentForPreview(firstFile.id, firstFile.mimeType, firstFile.name, firstFile);
                }

            } catch (err) {
                console.error("Upload error:", err);
                Swal.fire('อัปโหลดล้มเหลว', err.message, 'error');
            } finally {
                setUploading(false);
            }
        };

        // --- PREVIEW LOGIC ---
        const loadFileContentForPreview = async (fileId, mimeType, fileName, fileObj = null) => {
            setPreviewLoading(true);
            setImgScale(1);
            setImgRotate(0);
            setPan({ x: 0, y: 0 }); // Reset Pan

            if (!fileObj) {
                fileObj = files.find(f => f.id === fileId);
            }

            try {
                if (fileObj && fileObj.source === 'local') {
                    setPreviewFile({ url: fileObj.blobUrl, type: mimeType, name: fileName });
                    setIsFullScreen(false);
                } else {
                    let fetchUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
                    let headers = {};
                    
                    const tokenObj = gapi.client.getToken();
                    if (tokenObj && tokenObj.access_token) {
                        headers['Authorization'] = `Bearer ${tokenObj.access_token}`;
                    } else {
                        fetchUrl += `&key=${API_KEY}`;
                    }

                    const fetchRes = await fetch(fetchUrl, { headers });
                    
                    if (!fetchRes.ok) throw new Error("Fetch failed or permission denied");

                    const blob = await fetchRes.blob();
                    const type = mimeType.includes('html') ? 'text/html' : mimeType;
                    const url = URL.createObjectURL(new Blob([blob], { type: type }));
                    
                    setPreviewFile({ url, type: mimeType, name: fileName });
                    setIsFullScreen(false);
                }

            } catch (err) {
                console.error("Preview error:", err);
                Swal.fire('ไม่สามารถโหลดไฟล์ได้', 'ไฟล์อาจเป็นส่วนตัวหรือลิงก์หมดอายุ', 'error');
                setPreviewFile(null); 
            } finally {
                setPreviewLoading(false); 
            }
        };

        // --- UI HANDLERS ---
        const onFileChange = (e) => {
            if (e.target.files && e.target.files.length > 0) {
                handleFilesUpload(e.target.files);
            }
        };
        
        const onDrop = (e) => {
            e.preventDefault();
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                handleFilesUpload(e.dataTransfer.files);
            }
        };

        const onDragOver = (e) => e.preventDefault();

        // --- IMAGE TOOLS ---
        const handleZoomIn = () => setImgScale(prev => Math.min(prev + 0.25, 3));
        const handleZoomOut = () => setImgScale(prev => Math.max(prev - 0.25, 0.5));
        const handleRotate = () => setImgRotate(prev => prev + 90);
        const handleResetImg = () => { setImgScale(1); setImgRotate(0); setPan({ x: 0, y: 0 }); };
        
        // --- IMAGE PANNING ---
        const handleMouseDown = (e) => {
            e.preventDefault();
            setIsDragging(true);
            setDragStart({ x: e.clientX - pan.x, y: e.clientY - pan.y });
        };
        const handleMouseMove = (e) => {
            if (!isDragging) return;
            e.preventDefault();
            setPan({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y });
        };
        const handleMouseUp = () => setIsDragging(false);

        const handleSaveImage = () => {
            if (!previewFile) return;
            
            // If not rotated, download directly
            if (imgRotate % 360 === 0) {
                const a = document.createElement('a');
                a.href = previewFile.url;
                a.download = previewFile.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                return;
            }

            // If rotated, use canvas to save
            const img = new Image();
            img.src = previewFile.url;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const radians = (imgRotate * Math.PI) / 180;
                
                // Swap dims if 90/270
                if (imgRotate % 180 !== 0) {
                    canvas.width = img.height;
                    canvas.height = img.width;
                } else {
                    canvas.width = img.width;
                    canvas.height = img.height;
                }

                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(radians);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = previewFile.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            };
        };

        // --- RENDER ---
        const renderPreviewContent = () => {
            if (previewLoading) {
                return (
                    <div className="flex flex-col items-center justify-center h-full text-muted">
                        <div className="loader loader-lg mb-4"></div>
                        <p>กำลังโหลดตัวอย่าง...</p>
                    </div>
                );
            }

            if (!previewFile) return null;
            const { type, url } = previewFile;

            if (type.includes('image')) {
                return (
                    <div 
                        className="w-full h-full relative flex items-center justify-center bg-slate-900 overflow-hidden"
                        onMouseDown={handleMouseDown}
                        onMouseMove={handleMouseMove}
                        onMouseUp={handleMouseUp}
                        onMouseLeave={handleMouseUp}
                        style={{ cursor: isDragging ? 'grabbing' : (imgScale > 1 ? 'grab' : 'default') }}
                    >
                        <div 
                            className="transition-transform duration-75 ease-out origin-center will-change-transform"
                            style={{ transform: `translate(${pan.x}px, ${pan.y}px) scale(${imgScale}) rotate(${imgRotate}deg)` }}
                        >
                            <img src={url} alt="Preview" className="max-w-full max-h-[80vh] object-contain shadow-lg pointer-events-none" />
                        </div>
                        
                        {/* Image Floating Toolbar */}
                        <div className="absolute bottom-6 left-1/2 transform -translate-x-1/2 flex gap-2 bg-slate-800/90 p-2 rounded-full shadow-xl border border-slate-700 z-20 text-white">
                            <button onClick={handleZoomIn} className="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition" title="Zoom In">
                                <i className="fas fa-search-plus"></i>
                            </button>
                            <button onClick={handleZoomOut} className="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition" title="Zoom Out">
                                <i className="fas fa-search-minus"></i>
                            </button>
                            <button onClick={handleRotate} className="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition" title="Rotate">
                                <i className="fas fa-sync-alt"></i>
                            </button>
                            <button onClick={handleResetImg} className="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition" title="Reset">
                                <i className="fas fa-undo"></i>
                            </button>
                            <div className="w-px bg-slate-600 mx-1"></div>
                            <button onClick={handleSaveImage} className="w-10 h-10 rounded-full hover:bg-primary hover:text-white text-primary flex items-center justify-center transition" title="Save Image">
                                <i className="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                );
            } else if (type.includes('pdf')) {
                return (
                    <div className="w-full h-full relative group">
                        <iframe src={url} className="w-full h-full bg-white" title="PDF Preview"></iframe>
                        <div className="absolute bottom-4 right-4 z-10">
                             <a href={url} target="_blank" rel="noreferrer" className="bg-primary text-white px-4 py-2 rounded-full shadow-lg text-sm hover:bg-blue-600 transition flex items-center gap-2">
                                <i className="fas fa-external-link-alt"></i> เปิดไฟล์ PDF
                             </a>
                        </div>
                    </div>
                );
            } else {
                return <iframe src={url} className="w-full h-full bg-white" title="HTML Preview" sandbox="allow-scripts allow-same-origin"></iframe>;
            }
        };

        return (
            <div className="min-h-screen flex flex-col relative pb-20 md:pb-0 transition-colors duration-300">
                
                {/* Navbar */}
                <div className="bg-surface sticky top-0 z-30 shadow-md border-b border-border px-4 py-3 flex flex-col md:flex-row justify-between items-center transition-colors duration-300 gap-4">
                    {/* Logo + Mobile Theme Toggle */}
                    <div className="flex justify-between items-center w-full md:w-auto gap-3">
                        <div className="flex items-center gap-3">
                            <div className="bg-primary/10 p-2 rounded-lg text-primary border border-primary/20">
                                <i className="fab fa-google-drive text-xl"></i>
                            </div>
                            <div>
                                <h1 className="text-lg font-bold leading-tight text-text">Drive Upload</h1>
                                <p className="text-xs text-muted flex items-center gap-1">
                                    {isGuest ? <span className="text-secondary font-medium"><i className="fas fa-user-secret"></i> Guest Mode (Local)</span> : (isSharedView ? <span className="text-primary font-medium"><i className="fas fa-share-alt"></i> Shared View Mode</span> : "HTML, PDF & Image Preview")}
                                </p>
                            </div>
                        </div>

                         {/* Mobile Theme Toggle (Only show on Mobile) */}
                         <button 
                            onClick={toggleTheme}
                            className="w-9 h-9 rounded-full bg-main border border-border text-muted hover:text-primary flex items-center justify-center transition md:hidden"
                            title={isDarkMode ? "Switch to Light Mode" : "Switch to Dark Mode"}
                        >
                            <i className={`fas ${isDarkMode ? 'fa-sun' : 'fa-moon'}`}></i>
                        </button>
                    </div>
                    
                    {/* Auth Buttons + Desktop Theme Toggle */}
                    <div className="flex flex-col sm:flex-row items-center gap-3 w-full md:w-auto">
                        
                        {/* Desktop Theme Toggle (Only show on Desktop) */}
                        <button 
                            onClick={toggleTheme}
                            className="w-9 h-9 rounded-full bg-main border border-border text-muted hover:text-primary items-center justify-center transition hidden md:flex mr-2"
                            title={isDarkMode ? "Switch to Light Mode" : "Switch to Dark Mode"}
                        >
                            <i className={`fas ${isDarkMode ? 'fa-sun' : 'fa-moon'}`}></i>
                        </button>

                        {!user && !isGuest ? (
                            <div className="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                                <button 
                                    onClick={handleGuestClick}
                                    className="bg-secondary hover:bg-emerald-600 text-white border border-transparent px-4 py-2 rounded-full text-sm font-medium transition active:scale-95 shadow-sm w-full sm:w-auto text-center"
                                >
                                    ใช้งานแบบไม่ต้อง Login
                                </button>
                                <button 
                                    onClick={handleAuthClick}
                                    disabled={!gapiInited || !gisInited}
                                    className="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-medium shadow transition active:scale-95 flex items-center justify-center gap-2 w-full sm:w-auto"
                                >
                                    <i className="fab fa-google"></i> <span>เข้าสู่ระบบด้วย Google</span>
                                </button>
                            </div>
                        ) : (
                            <button 
                                onClick={handleSignoutClick}
                                className="bg-danger hover:bg-red-600 text-white px-4 py-2 rounded-full text-sm font-medium hover:text-white transition border border-transparent flex items-center justify-center gap-2 shadow-sm w-full sm:w-auto"
                                title="Sign Out"
                            >
                                <i className="fas fa-sign-out-alt"></i>
                                {isGuest ? "ออก (Exit Guest)" : "ออกจากระบบ"}
                            </button>
                        )}
                    </div>
                </div>

                {/* Main Content */}
                <div className="flex-1 w-full max-w-[95%] mx-auto p-4 md:p-6 grid grid-cols-1 md:grid-cols-12 gap-6">
                    
                    {/* Left: Upload & List (Hidden in Shared View) */}
                    {!isSharedView && (
                        <div className="md:col-span-4 lg:col-span-3 space-y-6 flex flex-col">
                            
                            {/* Upload Card */}
                            <div className="bg-surface rounded-2xl shadow-lg p-6 text-center border border-border transition-colors duration-300">
                                {user || isGuest ? (
                                    <>
                                        <div 
                                            onClick={() => document.getElementById('fileInput').click()}
                                            onDrop={onDrop}
                                            onDragOver={onDragOver}
                                            className={`border-2 border-dashed border-border bg-main rounded-xl p-8 cursor-pointer hover:border-primary transition active:scale-95 ${uploading ? 'opacity-50 pointer-events-none' : ''}`}
                                        >
                                            <input 
                                                type="file" 
                                                id="fileInput" 
                                                className="hidden" 
                                                accept=".html,.htm,.pdf,image/*" 
                                                multiple
                                                onChange={onFileChange} 
                                            />
                                            
                                            {uploading ? (
                                                <div className="flex flex-col items-center">
                                                    <div className="loader mb-3"></div>
                                                    <span className="text-sm text-primary animate-pulse">กำลังอัปโหลด...</span>
                                                </div>
                                            ) : (
                                                <div className="flex flex-col items-center">
                                                    <div className="w-14 h-14 bg-surface border border-border text-primary rounded-full flex items-center justify-center mb-3 text-2xl shadow-sm">
                                                        <i className="fas fa-cloud-upload-alt"></i>
                                                    </div>
                                                    <h3 className="font-semibold text-text">แตะเพื่อเลือกไฟล์</h3>
                                                    <p className="text-xs text-muted mt-1">หรือลากไฟล์มาวางที่นี่</p>
                                                    <p className="text-[10px] text-muted mt-1">(หลายไฟล์: HTML, PDF, รูปภาพ)</p>
                                                    {isGuest && <span className="text-[10px] text-secondary mt-2 bg-secondary/10 px-2 py-0.5 rounded">โหมด Guest (Local)</span>}
                                                </div>
                                            )}
                                        </div>
                                    </>
                                ) : (
                                    <div className="py-8 text-muted">
                                        <i className="fas fa-lock text-4xl mb-2 opacity-30"></i>
                                        <p className="text-sm">กรุณาเข้าสู่ระบบ หรือเลือกใช้งานแบบไม่ต้อง Login</p>
                                    </div>
                                )}
                            </div>

                            {/* File List */}
                            {(user || isGuest) && (
                                <div className="bg-surface rounded-2xl shadow-lg border border-border overflow-hidden transition-colors duration-300">
                                    <div className="px-5 py-3 border-b border-border bg-main flex justify-between items-center">
                                        <div className="flex items-center gap-2">
                                            <h3 className="font-semibold text-text text-sm">ไฟล์ล่าสุด</h3>
                                            <span className="text-xs bg-surface text-primary px-2 py-0.5 rounded-full border border-border">{files.length}</span>
                                        </div>
                                        {files.length > 0 && (
                                            <button 
                                                onClick={handleClearHistory} 
                                                disabled={isClearing}
                                                className={`text-[10px] transition flex items-center gap-1 ${isClearing ? 'text-gray-400 cursor-not-allowed' : 'text-muted hover:text-danger'}`}
                                            >
                                                {isClearing ? (
                                                    <>
                                                        <i className="fas fa-circle-notch fa-spin"></i> กำลังลบ...
                                                    </>
                                                ) : (
                                                    isGuest ? 'ล้างรายการ' : 'ล้างประวัติ (ลบไฟล์)'
                                                )}
                                            </button>
                                        )}
                                    </div>
                                    <div className="max-h-[600px] overflow-y-auto p-2 space-y-1 custom-scrollbar">
                                        {files.length === 0 ? (
                                            <div className="text-center py-8 text-muted text-sm">
                                                ยังไม่มีไฟล์ในรายการ
                                            </div>
                                        ) : (
                                            files.map(file => (
                                                <div key={file.id} 
                                                    onClick={() => loadFileContentForPreview(file.id, file.mimeType, file.name, file)}
                                                    className={`group flex items-center justify-between p-3 rounded-xl cursor-pointer transition border border-transparent 
                                                        ${previewFile && previewFile.name === file.name ? 'bg-primary/10 border-primary/30' : 'hover:bg-hover hover:border-border'}`}
                                                >
                                                    <div className="flex items-center gap-3 overflow-hidden flex-1">
                                                        <div className="w-8 h-8 rounded-lg bg-main flex items-center justify-center flex-shrink-0 border border-border relative">
                                                            <FileIcon mimeType={file.mimeType} />
                                                            {file.source === 'local' && <div className="absolute -bottom-1 -right-1 w-3 h-3 bg-secondary rounded-full border-2 border-surface"></div>}
                                                        </div>
                                                        <div className="truncate flex-1">
                                                            <p className={`text-sm font-medium truncate group-hover:text-primary ${previewFile && previewFile.name === file.name ? 'text-primary' : 'text-text'}`}>
                                                                {file.name}
                                                            </p>
                                                            <p className="text-[10px] text-muted uppercase flex items-center gap-1">
                                                                {file.mimeType.split('/').pop()}
                                                                {file.source === 'local' && <span className="text-secondary">• local</span>}
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-1">
                                                        {/* Share Button (Both Drive and Guest) */}
                                                        <button
                                                            onClick={(e) => handleShareFile(e, file)}
                                                            disabled={sharingId === file.id}
                                                            className={`w-8 h-8 rounded-full bg-transparent text-muted flex items-center justify-center transition-colors ${file.source === 'local' ? 'hover:bg-secondary/10 hover:text-secondary' : 'hover:bg-primary/10 hover:text-primary'}`}
                                                            title={file.source === 'local' ? "อัปโหลดเพื่อแชร์ (Public Link)" : "แชร์ไฟล์ (Public)"}
                                                        >
                                                            {sharingId === file.id ? <i className="fas fa-circle-notch fa-spin text-xs"></i> : <i className={`fas ${file.source === 'local' ? 'fa-cloud-upload-alt' : 'fa-share-alt'} text-xs`}></i>}
                                                        </button>

                                                        {deletingId === file.id ? (
                                                            <div className="loader w-4 h-4 border-2"></div>
                                                        ) : (
                                                            <button 
                                                                onClick={(e) => handleDeleteFile(e, file.id)}
                                                                className="w-8 h-8 rounded-full bg-transparent hover:bg-red-500/10 text-muted hover:text-red-500 flex items-center justify-center transition-colors"
                                                                title="ลบไฟล์"
                                                            >
                                                                <i className="fas fa-trash-alt text-xs"></i>
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Right: Preview */}
                    <div className={`${isSharedView ? 'col-span-1 md:col-span-12' : 'md:col-span-8 lg:col-span-9'} h-full`}>
                        {previewFile || previewLoading ? (
                            <div className="bg-surface rounded-2xl shadow-lg border border-border overflow-hidden flex flex-col h-full min-h-[600px] relative transition-colors duration-300">
                                {/* Preview Header */}
                                <div className="px-4 py-3 border-b border-border flex justify-between items-center bg-primary">
                                    <div className="flex items-center gap-2 overflow-hidden">
                                        <div className={`w-2 h-2 rounded-full ${previewLoading ? 'bg-yellow-300 animate-pulse' : 'bg-green-400'}`}></div>
                                        <span className="text-sm font-medium text-white truncate max-w-[150px] md:max-w-md">
                                            {previewFile ? previewFile.name : 'กำลังโหลด...'}
                                        </span>
                                    </div>
                                    <div className="flex gap-2">
                                        {previewFile && !previewLoading && (
                                            <button 
                                                onClick={() => setIsFullScreen(true)}
                                                className="bg-blue-900 hover:bg-blue-950 text-white px-3 py-1.5 rounded-lg text-xs transition flex items-center gap-1.5 shadow-sm"
                                            >
                                                <i className="fas fa-expand"></i> แสดงเต็มจอ
                                            </button>
                                        )}
                                        <button 
                                            onClick={() => { setPreviewFile(null); setPreviewLoading(false); setIsSharedView(false); }}
                                            className="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg text-xs transition flex items-center gap-1.5"
                                        >
                                            <i className="fas fa-times"></i> ปิด
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Preview Body */}
                                <div className="flex-1 bg-deep relative overflow-auto flex items-center justify-center">
                                    {renderPreviewContent()}
                                </div>
                            </div>
                        ) : (
                            <div className="bg-surface rounded-2xl shadow-lg border border-border h-full min-h-[600px] flex flex-col items-center justify-center text-center p-6 bg-pattern transition-colors duration-300">
                                <div className="w-20 h-20 bg-main rounded-full flex items-center justify-center mb-4 animate-bounce-slow border border-border">
                                    <i className="fas fa-laptop-code text-3xl text-muted"></i>
                                </div>
                                <h3 className="text-lg font-semibold text-text">พร้อมแสดงตัวอย่าง</h3>
                                <p className="text-sm text-muted max-w-xs mt-2">
                                    {isSharedView ? 'กำลังโหลดไฟล์ที่แชร์...' : 'เลือกไฟล์จากรายการด้านซ้าย หรืออัปโหลดไฟล์ใหม่เพื่อดูตัวอย่าง (HTML, PDF, รูปภาพ)'}
                                </p>
                            </div>
                        )}
                    </div>
                </div>

                {/* Full Screen Overlay */}
                {isFullScreen && previewFile && (
                    <div className="fixed inset-0 z-50 bg-black flex flex-col animate-fade-in">
                        <div className="bg-slate-900 text-white px-4 py-3 flex justify-between items-center border-b border-slate-800">
                            <h2 className="text-sm font-medium flex items-center gap-2 truncate text-slate-200">
                                <i className="fas fa-eye text-blue-500"></i>
                                {previewFile.name}
                            </h2>
                            <button 
                                onClick={() => setIsFullScreen(false)}
                                className="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm transition flex items-center gap-2 border border-slate-700"
                            >
                                <i className="fas fa-compress"></i> ปิดหน้าต่างเต็มจอ
                            </button>
                        </div>
                        <div className="flex-1 bg-black flex items-center justify-center overflow-hidden">
                            {renderPreviewContent()}
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>
